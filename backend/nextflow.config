// Nextflow configuration for Google Cloud Batch
// Configured for org policy compliance (internal IPs, shielded VMs)
workDir = 'gs://wz-workload-viz-bucket/scratch'

process {
  executor = 'google-batch'
  container = 'nextflow/rnaseq-nf'
  // Retry on any failure (spot preemption, transient errors, etc.)
  // Retry count resets when task runs successfully
  errorStrategy = 'retry'
  maxRetries = 5
  machineType = 'n1-standard-1'
  disk = '30 GB'
}

google {
  project = 'wz-workload-viz'
  location = 'us-central1'
  batch {
    spot = true
    serviceAccountEmail = 'nextflow-pipeline-sa@wz-workload-viz.iam.gserviceaccount.com'
    // Use internal IPs only (required by org policy: compute.vmExternalIpAccess)
    usePrivateAddress = true
    network = 'projects/wz-workload-viz/global/networks/default'
    subnetwork = 'projects/wz-workload-viz/regions/us-central1/subnetworks/default'
    // Note: Shielded VM is required by org policy: compute.requireShieldedVm
    // The nf-google plugin uses Batch API which should respect project-level defaults
    installGpuDrivers = false
  }
}

timeline {
  enabled = true
  file = 'timeline.html'
  overwrite = true
}

report {
  enabled = true
  file = 'report.html'
  overwrite = true
}
